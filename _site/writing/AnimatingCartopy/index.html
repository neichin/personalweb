<!DOCTYPE html>
<html lang="en">

<head>
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Just a personal site">

        <title>Animations with Cartopy in NEMO - Nacho Merino Personal Site</title>

    <link rel="canonical" href="http://neichin.github.io/personalweb/writing/AnimatingCartopy/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href=" /personalweb/css/clean-blog.css">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/personalweb/css/bootstrap.min.css">
   
    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/personalweb/css/syntax.css">

    <!-- Custom Fonts -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">



    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<link rel="shortcut icon" href="/favicon.ico">
</head>

<body>


    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/personalweb/">Nacho Merino Personal Site</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
<li>
                    <a href="/personalweb/publications/">Publications</a>
                </li>
<li>
                    <a href="/personalweb/material/">Material</a>
                </li>
<li>
                    <a href="/personalweb/writing/">Tips&Tricks</a>
                </li>
<li>
                    <a href="/personalweb/search/" class="nav-search-link" title="SEARCH">
		    <span class="fa fa-search nav-search-icon"></span>
		  </a>
		</li>



              <!-- 
                <li>
                    <a href="/personalweb/404/">404 - Page not found</a>
                </li>
                
                <li>
                    <a href="/personalweb/about/">About</a>
                </li>
                
                <li>
                    <a href="/personalweb/material/">Material</a>
                </li>
                
                <li>
                    <a href="/personalweb/material/meltwater/">Publications</a>
                </li>
                
                <li>
                    <a href="/personalweb/tips/">Writing</a>
                </li>
                
                <li>
                    <a href="/personalweb/results/">Writing</a>
                </li>
                
                <li>
                    <a href="/personalweb/publications/">Publications</a>
                </li>
                
                <li>
                    <a href="/personalweb/travels/">Writing</a>
                </li>
                
                <li>
                    <a href="/personalweb/gallery/">Gallery</a>
                </li>
                
                <li>
                    <a href="/personalweb/writing/">Tips and codes</a>
                </li>
                
                <li>
                    <a href="/personalweb/">Nacho Merino</a>
                </li>
                
                <li>
                    <a href="/personalweb/search/">Search</a>
                </li>
                 ...



            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>



    <html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        
        <meta name="viewport" content="width=device-width">

    </head>
    <body>
  <!-- Lightbox -->
<script src="http://jekyll-gallery-example.christianspecht.de/js/jquery-1.10.2.min.js"></script>
<script src="/personalweb/js/lightbox.js" type="text/javascript"></script>
<link href="/personalweb/css/lightbox.css" rel="stylesheet" />

  <!-- Footnotes -->
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.3/jquery-ui.min.js"></script>
<script src="/personalweb/js/bigfoot.js" type="text/javascript"></script>
<script type="text/javascript">
    $.bigfoot();
</script>
<link href="/personalweb/css/bigfoot.css" rel="stylesheet" />



<article>
<!-- Post Header -->
<header class="intro-header" style="background-image: url('/personalweb/img/blog/header/post-bg-02.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="site-headingSmall post-heading">
                    <h1 style="color: #acd578;">Animations with Cartopy in NEMO</h1>
                    
                    <span class="meta">Posted by Nacho on January 20, 2016</span>

<span class="time-tag-categ" style="font-size:.45em;background-color: rgba(128, 128, 128, 0.45);">

<i class="fa fa-clock-o"></i>&nbsp;
4 minute read



 
  &sim; Tagged with <i class="fa fa-tags"></i>&nbsp;:&nbsp;
<a href="/personalweb/writing/tag/Nemo/" data-toggle="tooltip" title="Other posts tagged with Nemo" rel="tag">Nemo</a>&nbsp;&bull;&nbsp;<a href="/personalweb/writing/tag/Cartopy/" data-toggle="tooltip" title="Other posts tagged with Cartopy" rel="tag">Cartopy</a>&nbsp;&bull;&nbsp;<a href="/personalweb/writing/tag/Python/" data-toggle="tooltip" title="Other posts tagged with Python" rel="tag">Python</a>


          
     
                           &sim; Filed in &nbsp;:&nbsp;<span class="post-tags"><a href="/personalweb/writing/category/Nemo/" data-toggle="tooltip" title="Other posts filed in Nemo category" rel="tag">Nemo</a>&nbsp;&bull;&nbsp;<a href="/personalweb/writing/category/Python/" data-toggle="tooltip" title="Other posts filed in Python category" rel="tag">Python</a></span>
                        
   </span>

                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">


               				<h1 id="animate-nemo-results-with-cartopy">Animate NEMO results with Cartopy</h1>

<h5 id="cartopy-is-the-best-solutions-i-found-to-plot-the-nemo-results-the-integration-with-matplotlib-library-is-perfect-and-almost-all-his-plot-features-remains-as-easy-as-working-with-cartesian-coordinates-resulting-in-very-intuitive-scripts">Cartopy is the best solutions I found to plot the NEMO results. The integration with Matplotlib library is perfect and almost all his plot features remains as easy as working with cartesian coordinates, Resulting in very intuitive scripts</h5>

<h5 id="some-problems-appear-when-we-want-to-animate-our-nemo-results-in-this-post-we-39-ll-try-to-solve-some-of-then-in-the-cleanest-way">Some problems appear when we want to animate our NEMO results. In this post we&#39;ll try to solve some of then in the cleanest way.</h5>

<h5 id="the-easiest-way-to-produce-animations-with-python-is-using-the-animation-module-of-matplotlib-hopefully-as-mentioneg-above-the-python-library-cartopy-allow-us-to-deal-with-geospatial-coordinates-using-matplotlib-at-the-same-time-the-basic-idea-of-the-animation-module-is-to-create-an-quot-update-function-quot-which-will-be-called-recursively-by-the-animation-generator-this-quot-update-function-quot-produce-a-set-of-images-that-will-be-merged-when-the-save-method-of-the-animation-module-is-called">The easiest way to produce animations with Python is using the animation module of Matplotlib. Hopefully, as mentioneg above, the Python library Cartopy allow us to deal with geospatial coordinates using Matplotlib at the same time. The basic idea of the animation module is to create an &quot;update function&quot; which will be called recursively by the animation generator. This &quot;update function&quot; produce a set of images that will be merged when the save method of the animation module is called.</h5>

<h5 id="in-our-case-since-we-are-plotting-data-in-maps-the-axes-are-made-with-some-heavy-features-as-bathymetry-contour-lines-specific-continent-coastal-lines-raster-image-which-make-the-axes-generation-very-slow-produce-a-simple-montly-animation-by-generating-and-regenerating-the-axis-every-single-time-the-quot-update-method-quot-is-called-can-make-the-animation-script-veeery-slow">In our case, since we are plotting data in maps, the axes are made with some heavy features as bathymetry contour lines, specific continent coastal lines, raster image... which make the axes generation very slow. Produce a simple montly animation by generating and regenerating the axis every single time the &quot;update method&quot; is called can make the animation script veeery slow.</h5>

<h5 id="the-challenge-here-is-to-clean-up-the-data-that-have-be-previously-plotted-without-removing-the-axes-that-means-that-we-can-not-use-for-instance-fig-clean-or-similar-calls-my-first-idea-the-most-clean-and-elegant-was-to-create-the-axes-once-and-use-the-deepcopy-method-of-the-copy-module-at-the-interior-of-the-update-function-this-would-allow-me-to-plot-a-new-scatter-plot-every-time-the-update-function-is-called-something-like">The challenge here is to clean up the data that have be previously plotted, without removing the axes. That means that we can not use for instance fig.clean() or similar calls. My first idea (the most clean and elegant) was to create the axes once, and use the deepcopy method of the copy module at the interior of the update function. This would allow me to plot a new scatter plot every time the update function is called. Something like:</h5>
<figure class="highlight"><pre><code class="language-python" data-lang="python">def update(self)
    axesLocal=copy.deepcopy(axes)
</code></pre></figure>
<h5 id="sadly-deepcopy-method-crashes-with-axis-objects">Sadly, deepcopy method crashes with axis objects:</h5>
<figure class="highlight"><pre><code class="language-text" data-lang="text">NotImplementedError: TransformNode instances can not be copied. Consider using frozen() instead.
</code></pre></figure>
<h5 id="the-second-idea-was-to-use-the-set_array-and-the-set_offets-methods-of-the-scatter-plot-to-update-the-plot-data-which-is-a-very-nice-practice-when-producing-animations-those-methods-do-not-seem-to-be-implemented-yet-with-the-cartopy-interface-and-they-do-not-take-the-transformation-argument-the-results-is-the-data-cannot-be-projected-in-your-cartopy-axes">The second idea was to use the set_array and the set_offets methods of the scatter plot to update the plot data. Which is a very nice practice when producing animations, Those methods do not seem to be implemented yet with the cartopy interface, and they do not take the transformation argument. The results is the data cannot be projected in your cartopy axes.</h5>

<h5 id="finally-the-best-and-quickest-solution-is-to-use-the-scatter-remove-method-this-method-removes-the-scatter-instance-that-was-created-and-asociated-to-a-global-varible-by-the-quot-update-method-quot-called-before-the-axis-and-the-figure-remains">Finally the best and quickest solution is to use the scatter.remove() method. This method removes the scatter instance that was created and asociated to a global varible by the &quot;update method&quot; called before. The axis and the figure remains</h5>

<h5 id="the-main-program-just-open-the-data-with-the-shape-temporal-latitud-longitud-in-this-example-i-only-need-the-300-first-latitude-values-temporal-dimension-is-12-one-per-month">The main program just open the data with the shape (temporal, latitud, longitud). In this example I only need the 300 first latitude values. Temporal dimension is 12 (one per month).</h5>

<h5 id="main-looks-as-simple-as-this">Main looks as simple as this:</h5>
<figure class="highlight"><pre><code class="language-python" data-lang="python">
import netCDF4
import numpy as np
import matplotlib.pyplot as plt
import cartopy.crs as ccrs
import pylab as m
import matplotlib.cm as cm
from matplotlib import animation
from matplotlib.colors import LogNorm

if __name__ == &#39;__main__&#39;:

    #opening lon and lat values
    ncfile = netCDF4.Dataset(&#39;/Path/to/Data/mesh_hgr.nc&#39;,&#39;a&#39;)
    lonVar= np.array(ncfile.variables[&#39;nav_lon&#39;])[0:300,:]
    latVar= np.array(ncfile.variables[&#39;nav_lat&#39;])[0:300,:]
    ncfile.close()

    #Opening the Icebergs Flux Data
    path=&#39;/Path/to/Data/Climato_Icebergs.nc&#39;
    ncfile = netCDF4.Dataset(path,&#39;a&#39;)
    RunoffVar = np.array(ncfile.variables[&#39;Melt&#39;])[:,0:300,:]*3600*24 #Kg/s--&gt;mm/day
    ncfile.close()

    ChampVar=RunoffVar

    #The MP4 file I want to produce
    animationname=path+&#39;/test.mp4&#39;

    #aniationGeneral(Field I want to plot,
    #               Time steps , 
    #               Longitud Field, 
    #               Latitud Field,
    #               Min Value of the colorbar,
    #               Max Value of the colorbar,
    #               File name
    a = animationGeneral(ChampVar,12,lonVar,latVar,-1,1,animationname)

    #Show at the end
    #a.show()
</code></pre></figure>
<h4 id="the-main-routine-basically-open-the-data-and-create-and-object-of-the-class-animationgeneral-this-object-is-the-film-with-the-given-name">The main routine basically open the data and create and object of the class animationGeneral. This object is the film with the given name.</h4>
<figure class="highlight"><pre><code class="language-python" data-lang="python">class animationGeneral(object):
# First set up the figure, the axis, and the plot element we want to animate
    def __init__(self, champ, stepNum,lon,lat,vmin,vmax,animationname):
        #Global definitions
        self.MassVar=champ
        self.lonVar=lon
        self.latVar=lat
        self.t=0
        self.vmin=vmin
        self.vmax=vmax

        #Figure
        self.fig = plt.figure()

        #Axes definition
        self.ax = plt.axes(projection=ccrs.SouthPolarStereo())
        self.ax.set_extent([-200, 200, -45, -45],ccrs.PlateCarree())

        #The plot to animate
        self.scat2=self.ax.scatter(0, 90, c=1
            ,vmax=self.vmax
            ,vmin=self.vmin
            #,cmap=&#39;coolwarm&#39;
            , norm = LogNorm()
            ,transform=ccrs.PlateCarree(),edgecolor=&#39;none&#39;,s=0.6)
        cbar=plt.colorbar(self.scat2)
        cbar.set_label(&#39;Melt water Flux (mm/yr)&#39;)

        #Adding my own Antarctica graphics
        drawAntarctica(self.ax)

        #Animation definitio
        anim = animation.FuncAnimation(self.fig, self.update,np.arange(stepNum), interval=1, blit=False)

        #Writer FFMpeg needed for mp4 film
        mywriter = animation.FFMpegWriter()
        anim.save(animationname, writer=mywriter,fps=1, extra_args=[&#39;-vcodec&#39;, &#39;libx264&#39;])

    #No init_plot needed
    def setup_plot(self):



    # animation function to be called nsteps times plus the initialisation since init_func isn&#39;t defined
    def update(self,i):
        t=i
        print t,&#39;setup&#39;

        #Index of the dat to be extrated
        index=np.where(self.MassVar[t,:,:]*(self.latVar[:,:]&lt;-30)!=0.)
        #Remove previous data plotted
        self.scat2.remove()
        #The plot with Logaritmic scale
        self.scat2=self.ax.scatter(self.lonVar[index], self.latVar[index], c=self.MassVar[t,index[0],index[1]]
            ,vmax=self.vmax
            ,vmin=self.vmin
            #,cmap=&#39;coolwarm&#39;
            , norm = LogNorm()
            ,transform=ccrs.PlateCarree(),edgecolor=&#39;none&#39;,s=0.6)

        return self.scat2,    


    def show(self):
        plt.show()
</code></pre></figure>
<h6 id="in-this-example-draantarctica-ax-is-only-called-once-doing-the-animation-script-much-lighter">In this example, <code>draAntarctica(ax)</code> is only called once, doing the animation script much lighter</h6>

<iframe width="420" height="315" src="/personalweb/videos/animationIcebergsMonth.mp4" frameborder="0" allowfullscreen></iframe>

<video  preload='metadata' controls ><source src='/videos/animationIcebergsMonth.mp4' type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'></video>


                <br>

 <div class="post-share text-center">
    <p class="light small">
        <h6>Share this post</h6>
    </p>
    <ul class="social-mini">
        <li>
            <a href="https://twitter.com/intent/tweet?text=&quot;Animations with Cartopy in NEMO&quot;%20http://neichin.github.io/personalweb/writing/AnimatingCartopy/%20via%20&#64;"
            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" data-toggle="tooltip" title="Share on Twitter" itemprop="Twitter">
                <span class="fa-stack fa-lg" style="
color: #223333;font-size:1em;">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>

            </a>
        </li>
        <li>
            <a  href="https://www.facebook.com/sharer/sharer.php?u=http://neichin.github.io/personalweb/writing/AnimatingCartopy/"
            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" data-toggle="tooltip" title="Share on Facebook" itemprop="Facebook">
                <span class="fa-stack fa-lg" style="
color: #223333;font-size:1em;">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>

            </a>
        </li>
        <li>
            <a href="https://plus.google.com/share?url=http://neichin.github.io/personalweb/writing/AnimatingCartopy/"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" data-toggle="tooltip" title="Share on Google plus" itemprop="GooglePlus">
                <span class="fa-stack fa-lg" style="
color: #223333;font-size:1em;">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
                            </span>

            </a>
        </li>
    </ul></div>
<div id="disqus_thread"></div>
<script>
        var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');
        
        s.src = '//thewriteway.disqus.com/embed.js';  // IMPORTANT: Replace 'thewriteway' with your forum shortname!
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

                        
                <br>

                <ul class="pager">
                    
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<br>



</body>
</html>





    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p class="copyright text-muted">Nacho Merino Personal Site &copy;  2016</p>
<center><h6><p>Powered by <a href="https://github.com/">Github</a> - <a href="https://github.com/jekyll/">Jekyll</a> - <a href="https://github.com/madforjekyll/madforjekyll.github.io">MAD4Jekyll</a>.</p></h6></center>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="http://neichin.github.io/personalweb/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="http://neichin.github.io/personalweb/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="http://neichin.github.io/personalweb/js/clean-blog.min.js"></script>


<script>
//** jQuery Scroll to Top Control script- (c) 
//** v1.1 (April 7th, 10')
//** 1) Adds ability to scroll to an absolute position (from top of page) or specific element on the page instead.
//** 2) Fixes scroll animation not working in Opera. 
var scrolltotop={
//startline: Integer. Number of pixels from top of doc scrollbar is scrolled before showing control
//scrollto: Keyword (Integer, or "Scroll_to_Element_ID"). How far to scroll document up when control is clicked on (0=top).
setting: {startline:100, scrollto: 0, scrollduration:1000, fadeduration:[500, 100]},
controlHTML: '<img src="https://cloud.githubusercontent.com/assets/14811095/10860257/a11dcaec-7f6e-11e5-9d75-e581a4259665.png" style="filter:alpha(opacity=100); -moz-opacity:1;"/>', //HTML for control, which is auto wrapped in DIV w/ ID="topcontrol"
controlattrs: {offsetx:35, offsety:60}, //offset of control relative to right/ bottom of window corner
anchorkeyword: '#top', //Enter href value of HTML anchors on the page that should also act as "Scroll Up" links
state: {isvisible:false, shouldvisible:false},
scrollup:function(){
if (!this.cssfixedsupport) //if control is positioned using JavaScript
this.$control.css({opacity:0}) //hide control immediately after clicking it
var dest=isNaN(this.setting.scrollto)? this.setting.scrollto : parseInt(this.setting.scrollto)
if (typeof dest=="string" && jQuery('#'+dest).length==1) //check element set by string exists
dest=jQuery('#'+dest).offset().top
else
dest=0
this.$body.animate({scrollTop: dest}, this.setting.scrollduration);
},
keepfixed:function(){
var $window=jQuery(window)
var controlx=$window.scrollLeft() + $window.width() - this.$control.width() - this.controlattrs.offsetx
var controly=$window.scrollTop() + $window.height() - this.$control.height() - this.controlattrs.offsety
this.$control.css({left:controlx+'px', top:controly+'px'})

},

togglecontrol:function(){
var scrolltop=jQuery(window).scrollTop()
if (!this.cssfixedsupport)
this.keepfixed()
this.state.shouldvisible=(scrolltop>=this.setting.startline)? true : false
if (this.state.shouldvisible && !this.state.isvisible){
this.$control.stop().animate({opacity:1}, this.setting.fadeduration[0])
this.state.isvisible=true
}
else if (this.state.shouldvisible==false && this.state.isvisible){
this.$control.stop().animate({opacity:0}, this.setting.fadeduration[1])
this.state.isvisible=false
}

},
init:function(){
jQuery(document).ready(function($){
var mainobj=scrolltotop
var iebrws=document.all

mainobj.cssfixedsupport=!iebrws || iebrws && document.compatMode=="CSS1Compat" && window.XMLHttpRequest //not IE or IE7+ browsers in standards mode
mainobj.$body=(window.opera)? (document.compatMode=="CSS1Compat"? $('html') : $('body')) : $('html,body')
mainobj.$control=$('<div id="topcontrol">'+mainobj.controlHTML+'</div>')
.css({position:mainobj.cssfixedsupport? 'fixed' : 'absolute', bottom:mainobj.controlattrs.offsety, right:mainobj.controlattrs.offsetx, opacity:0, cursor:'pointer'})
.attr({title:'Scroll To Top'})
.click(function(){mainobj.scrollup(); return false})
.appendTo('body')

if (document.all && !window.XMLHttpRequest && mainobj.$control.text()!='') //loose check for IE6 and below, plus whether control contains any text
mainobj.$control.css({width:mainobj.$control.width()}) //IE6- seems to require an explicit width on a DIV containing text
mainobj.togglecontrol()

$('a[href="' + mainobj.anchorkeyword +'"]').click(function(){
mainobj.scrollup()

return false
})

$(window).bind('scroll resize', function(e){

mainobj.togglecontrol()

})

})

}

}

scrolltotop.init()
</script>

</body>

</html>
